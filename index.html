<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Conhecimento e Atendimentos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --color-bg: #0a0f1f;
            --color-surface: #10183b;
            --color-primary: #2a3a90;
            --color-accent: #3b82f6;
            --color-text: #e5e7eb;
            --color-text-muted: #9ca3af;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            overflow-x: hidden;
        }

        #webgl-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .panel {
            background: rgba(16, 24, 59, 0.85); /* var(--color-surface) with alpha */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(42, 58, 144, 0.3); /* var(--color-primary) with alpha */
            box-shadow: 0 8px 32px 0 rgba(10, 15, 31, 0.37);
            border-radius: 0.75rem;
        }
        
        .dark-panel {
             background: rgba(16, 24, 59, 0.85);
        }
        .dark-panel h3 {
            color: var(--color-accent);
        }
        .dark-panel p {
            color: var(--color-text);
        }
        .dark-panel button {
             color: var(--color-accent);
        }

        /* Estilo para os novos selects */
        .dark-select {
            background-color: var(--color-surface);
            border: 1px solid var(--color-primary);
            color: var(--color-text);
        }
        .dark-select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-accent);
        }


        .tab-btn.active {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }

        .subject-list {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s ease-in-out;
        }
        .subject-list > div {
            overflow: hidden;
        }
        .subject-list.expanded {
            grid-template-rows: 1fr;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent);
        }

        /* Animações e Efeitos */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .glow-on-hover {
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }
        .glow-on-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 15px 2px var(--color-accent);
        }
    </style>
</head>
<body class="antialiased">

    <canvas id="webgl-bg"></canvas>

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 bg-bg flex items-center justify-center z-50 animate-fade-in">
        <div class="panel w-full max-w-sm p-8">
            <h2 class="text-2xl font-bold text-center text-accent mb-6">Acessar Sistema</h2>
            <div class="space-y-4">
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-text-muted mb-1">Senha</label>
                    <input type="password" id="passwordInput" class="w-full bg-surface/80 border border-primary rounded-lg px-4 py-2 text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent">
                </div>
                <button id="loginBtn" class="w-full bg-accent hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg glow-on-hover">Entrar</button>
                <p id="loginError" class="text-red-500 text-sm text-center h-4"></p>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal (oculto por padrão) -->
    <div id="main-content" class="relative z-10 hidden">
        <div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">
            
            <div class="mb-6 border-b" style="border-color: var(--color-primary);">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button id="tab-knowledge" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-lg text-text-muted hover:text-text transition-colors duration-300">Base de Conhecimento</button>
                    <button id="tab-dashboard-knowledge" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-medium text-lg text-text-muted hover:text-text transition-colors duration-300 admin-feature">Dashboard (Conhecimento)</button>
                    <button id="tab-dashboard-tickets" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 border-transparent font-medium text-lg text-text-muted hover:text-text transition-colors duration-300 admin-feature">Dashboard (Atendimentos)</button>
                </nav>
            </div>

            <!-- Conteúdo da Aba Base de Conhecimento -->
            <div id="content-knowledge">
                <header class="mb-6">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Pesquisar por categorias e assuntos..." class="w-full bg-surface/80 border border-primary rounded-lg pl-10 pr-4 py-3 text-text placeholder-text-muted focus:outline-none focus:ring-2 focus:ring-accent transition-all duration-300">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    <div id="header-buttons" class="flex items-center justify-end gap-3 mt-4 relative">
                        <!-- Botão de Logout será injetado aqui pelo JS -->
                        <div class="relative" id="export-container">
                            <button id="exportBtn" title="Exportar dados" class="p-2 bg-surface hover:bg-primary border border-primary/50 rounded-full glow-on-hover">
                                <svg class="w-6 h-6 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </button>
                            <div id="exportMenu" class="hidden absolute right-0 mt-2 w-48 panel rounded-md shadow-lg z-20 animate-fade-in">
                                <a href="#" id="exportExcelBtn" class="block px-4 py-2 text-sm text-text-muted hover:bg-primary">Exportar para Excel (.xlsx)</a>
                                <a href="#" id="exportMarkdownBtn" class="block px-4 py-2 text-sm text-text-muted hover:bg-primary">Exportar para Markdown (.md)</a>
                            </div>
                        </div>
                        <button id="importBtn" title="Importar de arquivo .txt" class="p-2 bg-surface hover:bg-primary border border-primary/50 rounded-full glow-on-hover">
                            <svg class="w-6 h-6 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        </button>
                         <button id="addCategoryBtn" title="Adicionar nova categoria" class="p-2 bg-accent hover:opacity-90 text-white rounded-full shadow-lg glow-on-hover">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept=".txt,.md">
                    </div>
                     <div id="addCategoryForm" class="hidden mt-4 animate-fade-in">
                        <div class="flex gap-2">
                            <input type="text" id="newCategoryInput" placeholder="Nome da nova categoria" class="flex-grow bg-white border border-primary rounded-lg px-4 py-2 text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-accent">
                            <button id="saveCategoryBtn" class="bg-accent hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg glow-on-hover">Salvar</button>
                        </div>
                    </div>
                </header>
                <main id="categoriesContainer" class="space-y-3"></main>
            </div>

            <!-- Conteúdo da Aba Dashboard (Base de Conhecimento) -->
            <div id="content-dashboard-knowledge" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="panel dark-panel p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Total de Categorias</h3>
                        <p id="totalCategories" class="text-4xl font-bold">0</p>
                    </div>
                    <div class="panel dark-panel p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Total de Assuntos</h3>
                        <p id="totalSubjects" class="text-4xl font-bold">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div class="panel dark-panel p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4">Distribuição de Assuntos por Categoria</h3>
                        <div class="relative h-96"><canvas id="categoriesChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba Dashboard (Atendimentos) -->
            <div id="content-dashboard-tickets" class="hidden">
                <div class="panel dark-panel p-6 rounded-lg mb-6 text-center">
                    <h2 class="text-2xl font-bold mb-4">Análise de Atendimentos</h2>
                    <button id="loadTicketsBtn" class="bg-accent hover:opacity-90 text-white font-bold py-2 px-6 rounded-lg glow-on-hover">Carregar Dados dos Atendimentos (.txt)</button>
                    <input type="file" id="ticketsFileInput" class="hidden" accept=".txt">
                </div>

                <!-- Seção de Seleção de Categoria e Assunto -->
                <div id="ticket-selector-panel" class="panel dark-panel p-6 rounded-lg mb-6 animate-fade-in">
                    <h3 class="text-xl font-semibold mb-4 text-accent">Filtrar Assuntos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="ticketCategorySelect" class="block text-sm font-medium text-text-muted mb-2">Categoria de Assunto do Ticket</label>
                            <select id="ticketCategorySelect" class="w-full dark-select rounded-lg p-2">
                                <option value="">Carregando categorias...</option>
                            </select>
                        </div>
                        <div>
                            <label for="ticketSubjectSelect" class="block text-sm font-medium text-text-muted mb-2">Assunto do Ticket</label>
                            <select id="ticketSubjectSelect" class="w-full dark-select rounded-lg p-2">
                                <option value="">Aguardando seleção da categoria</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="ticketsDashboardContent" class="hidden animate-fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="panel dark-panel p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Total de Tickets</h3>
                            <p id="totalTickets" class="text-4xl font-bold">0</p>
                        </div>
                        <div class="panel dark-panel p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Responsáveis</h3>
                            <p id="totalAgents" class="text-4xl font-bold">0</p>
                        </div>
                        <div class="panel dark-panel p-6 rounded-lg">
                            <h3 class="text-lg font-semibold mb-2">Tipos de Chamado</h3>
                            <p id="totalTicketTypes" class="text-4xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="panel dark-panel p-6 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-4">Distribuição por Tipo de Chamado</h3>
                            <div class="flex-grow relative"><canvas id="ticketTypesChart"></canvas></div>
                             <div class="mt-4 text-center">
                                <button data-chart-id="ticketTypesChart" class="toggle-chart-btn hidden hover:opacity-80 transition-opacity duration-200 text-sm">
                                    Ver mais
                                    <svg class="inline-block w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                         <div class="panel dark-panel p-6 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-4">Atendimentos por Categoria de Assunto</h3>
                            <div class="flex-grow relative"><canvas id="ticketCategoriesChart"></canvas></div>
                             <div class="mt-4 text-center">
                                <button data-chart-id="ticketCategoriesChart" class="toggle-chart-btn hidden hover:opacity-80 transition-opacity duration-200 text-sm">
                                    Ver mais
                                    <svg class="inline-block w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                         <div class="panel dark-panel p-6 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-4">Atendimentos por Assunto Específico</h3>
                            <div class="flex-grow relative"><canvas id="ticketSubjectsChart"></canvas></div>
                             <div class="mt-4 text-center">
                                <button data-chart-id="ticketSubjectsChart" class="toggle-chart-btn hidden hover:opacity-80 transition-opacity duration-200 text-sm">
                                    Ver mais
                                    <svg class="inline-block w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="panel dark-panel p-6 rounded-lg flex flex-col">
                            <h3 class="text-xl font-semibold mb-4">Análise de Categoria por Tipo de Chamado</h3>
                            <div class="flex-grow relative chart-scroll-container"><canvas id="categoryByTypeChart"></canvas></div>
                             <div class="mt-4 text-center">
                                <button data-chart-id="categoryByTypeChart" class="toggle-chart-btn hidden hover:opacity-80 transition-opacity duration-200 text-sm">
                                    Ver mais
                                    <svg class="inline-block w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Animação de Fundo com Three.js ---
            let scene, camera, renderer, stars;

            function initThreeJS() {
                const canvas = document.getElementById('webgl-bg');
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.z = 1;
                camera.rotation.x = Math.PI / 2;

                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x0a0f1f, 1); // Cor de fundo

                const starGeo = new THREE.BufferGeometry();
                const starVertices = [];
                for (let i = 0; i < 6000; i++) {
                    const x = (Math.random() - 0.5) * 2000;
                    const y = (Math.random() - 0.5) * 2000;
                    const z = (Math.random() - 0.5) * 2000;
                    starVertices.push(x, y, z);
                }
                starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));

                let starMaterial = new THREE.PointsMaterial({
                    color: 0xaaaaaa,
                    size: 0.7,
                });

                stars = new THREE.Points(starGeo, starMaterial);
                scene.add(stars);

                window.addEventListener('resize', onWindowResize, false);
                animate();
            }

            function onWindowResize() {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }

            function animate() {
                stars.rotation.y += 0.0002;
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            }

            initThreeJS();

            // --- Variáveis e Seletores Globais ---
            let categories = [];
            let knowledgeCategoriesChartInstance = null;

            // --- Seletores de Login ---
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            // --- Seletores de Permissões ---
            const adminFeatures = document.querySelectorAll('.admin-feature');
            const exportContainer = document.getElementById('export-container');
            const headerButtons = document.getElementById('header-buttons');

            // --- Seletores de Abas e Conteúdo ---
            const tabKnowledge = document.getElementById('tab-knowledge');
            const tabDashboardKnowledge = document.getElementById('tab-dashboard-knowledge');
            const tabDashboardTickets = document.getElementById('tab-dashboard-tickets');
            const contentKnowledge = document.getElementById('content-knowledge');
            const contentDashboardKnowledge = document.getElementById('content-dashboard-knowledge');
            const contentDashboardTickets = document.getElementById('content-dashboard-tickets');
            const totalCategoriesEl = document.getElementById('totalCategories');
            const totalSubjectsEl = document.getElementById('totalSubjects');
            const categoriesChartEl = document.getElementById('categoriesChart');

            // --- Funções Globais ---
            const updateDashboardKnowledge = () => {
                const totalSubjects = categories.reduce((acc, cat) => acc + cat.subjects.length, 0);
                totalCategoriesEl.textContent = categories.length;
                totalSubjectsEl.textContent = totalSubjects;
                
                const chartColors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444'];
                const sortedCategories = [...categories].sort((a, b) => b.subjects.length - a.subjects.length);
                const categoryLabels = sortedCategories.map(c => c.name);
                const categoryData = sortedCategories.map(c => c.subjects.length);
                
                if (knowledgeCategoriesChartInstance) knowledgeCategoriesChartInstance.destroy();
                knowledgeCategoriesChartInstance = new Chart(categoriesChartEl, {
                    type: 'bar',
                    data: {
                        labels: categoryLabels,
                        datasets: [{ 
                            label: 'Nº de Assuntos', 
                            data: categoryData, 
                            backgroundColor: chartColors
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(255,255,255,0.1)' } }, 
                            y: { ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(255,255,255,0.1)' } } 
                        }
                    }
                });
            };

            const switchTab = (activeTab) => {
                const tabs = [
                    { btn: tabKnowledge, content: contentKnowledge, name: 'knowledge' },
                    { btn: tabDashboardKnowledge, content: contentDashboardKnowledge, name: 'dashboard-knowledge' },
                    { btn: tabDashboardTickets, content: contentDashboardTickets, name: 'dashboard-tickets' }
                ];

                tabs.forEach(tab => {
                    if (tab.name === activeTab) {
                        tab.btn.classList.add('active');
                        tab.content.classList.remove('hidden');
                    } else {
                        tab.btn.classList.remove('active');
                        tab.content.classList.add('hidden');
                    }
                });

                if (activeTab === 'dashboard-knowledge') {
                    updateDashboardKnowledge();
                }
            };
            
            // --- Lógica do Sistema de Login ---
            const handleLogin = () => {
                const password = passwordInput.value;
                loginError.textContent = '';
                let role = null;

                if (password === 'a') {
                    role = 'standard';
                } else if (password === 'LC2025') { // SENHA DO ADMIN ALTERADA
                    role = 'admin';
                }

                if (role) {
                    sessionStorage.setItem('userRole', role);
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    applyPermissions(role);
                    initializeApp();
                } else {
                    loginError.textContent = 'Senha incorreta.';
                    passwordInput.focus();
                }
            };

            const handleLogout = () => {
                sessionStorage.removeItem('userRole');
                location.reload();
            };

            const applyPermissions = (role) => {
                if (role === 'standard') {
                    adminFeatures.forEach(el => el.classList.add('hidden'));
                    if(exportContainer) exportContainer.classList.add('hidden');
                    switchTab('knowledge');
                } else if (role === 'admin') {
                    adminFeatures.forEach(el => el.classList.remove('hidden'));
                     if(exportContainer) exportContainer.classList.remove('hidden');
                }
            };
            
            const checkLoginState = () => {
                const role = sessionStorage.getItem('userRole');
                if (role) {
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    applyPermissions(role);
                    initializeApp();
                } else {
                    loginScreen.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                }
            };

            // --- Função para inicializar o app principal ---
            const initializeApp = () => {
                
                const chartInstances = {
                    ticketTypesChart: null,
                    ticketCategoriesChart: null,
                    ticketSubjectsChart: null,
                    categoryByTypeChart: null
                };
                const fullChartData = {};

                // --- Seletores de Elementos ---
                const searchInput = document.getElementById('searchInput');
                const addCategoryBtn = document.getElementById('addCategoryBtn');
                const addCategoryForm = document.getElementById('addCategoryForm');
                const newCategoryInput = document.getElementById('newCategoryInput');
                const saveCategoryBtn = document.getElementById('saveCategoryBtn');
                const categoriesContainer = document.getElementById('categoriesContainer');
                const importBtn = document.getElementById('importBtn');
                const exportBtn = document.getElementById('exportBtn');
                const exportMenu = document.getElementById('exportMenu');
                const exportExcelBtn = document.getElementById('exportExcelBtn');
                const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
                const fileInput = document.getElementById('fileInput');
                
                const loadTicketsBtn = document.getElementById('loadTicketsBtn');
                const ticketsFileInput = document.getElementById('ticketsFileInput');
                const ticketsDashboardContent = document.getElementById('ticketsDashboardContent');
                const totalTicketsEl = document.getElementById('totalTickets');
                const totalAgentsEl = document.getElementById('totalAgents');
                const totalTicketTypesEl = document.getElementById('totalTicketTypes');

                // --- Adiciona Botão de Logout ---
                if (!document.getElementById('logoutBtn')) {
                    const logoutBtn = document.createElement('button');
                    logoutBtn.id = 'logoutBtn';
                    logoutBtn.title = 'Sair (voltar para tela de login)';
                    logoutBtn.className = 'p-2 bg-surface hover:bg-primary border border-primary/50 rounded-full glow-on-hover';
                    logoutBtn.innerHTML = `<svg class="w-6 h-6 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4"></path></svg>`;
                    headerButtons.prepend(logoutBtn); // Adiciona como primeiro botão
                    logoutBtn.addEventListener('click', handleLogout);
                }

                // --- Lógica da Base de Conhecimento ---
                const loadData = () => {
                    const storedData = localStorage.getItem('knowledgeBaseDataV2');
                    categories = storedData ? JSON.parse(storedData) : [];
                    render();
                };

                const saveData = () => {
                    localStorage.setItem('knowledgeBaseDataV2', JSON.stringify(categories));
                    if (!contentDashboardKnowledge.classList.contains('hidden')) {
                        updateDashboardKnowledge();
                    }
                };

                const render = (dataToRender = categories, scrollY = null) => {
                    categoriesContainer.innerHTML = '';
                    if (dataToRender.length === 0) {
                        const searchTerm = searchInput.value.trim();
                        const message = searchTerm ? `Nenhuma categoria encontrada para "${searchTerm}".` : "Nenhuma categoria. Clique no '+' para começar.";
                        categoriesContainer.innerHTML = `<div class="text-center text-text-muted py-10">${message}</div>`;
                        return;
                    }
                    dataToRender.forEach(category => {
                        const isExpanded = category.expanded || false;
                        const categoryElement = document.createElement('div');
                        categoryElement.className = 'panel rounded-lg';

                        const searchTerm = searchInput.value.toLowerCase().trim();
                        const categoryNameMatches = category.name.toLowerCase().includes(searchTerm);

                        const subjectsToDisplay = (searchTerm && !categoryNameMatches)
                            ? category.subjects.filter(s => s.toLowerCase().includes(searchTerm))
                            : category.subjects;

                        const subjectsHTML = subjectsToDisplay.map((subject) => `
                            <li class="group flex items-center justify-between text-text ml-2 p-1 rounded-md hover:bg-primary/20 transition-colors duration-200">
                                <span class="truncate pr-2">${subject}</span>
                                <div class="relative options-btn-container">
                                    <button class="options-btn p-1 rounded-full hover:bg-primary/50" data-type="subject" data-id="${category.id}" data-subject="${subject.replace(/"/g, '&quot;')}">
                                        <svg class="w-5 h-5 text-text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                                    </button>
                                    <div class="options-menu hidden absolute right-0 mt-1 w-32 panel rounded-md shadow-lg z-10 animate-fade-in">
                                        <a href="#" class="edit-btn block px-4 py-2 text-sm text-text-muted hover:bg-primary">Editar</a>
                                        <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-500 hover:bg-primary">Excluir</a>
                                    </div>
                                </div>
                            </li>`).join('');
                        const placeholderHTML = '<li class="text-text-muted text-sm ml-2">Nenhum assunto.</li>';

                        categoryElement.innerHTML = `
                            <div class="group flex items-center justify-between p-4 cursor-pointer category-header" data-id="${category.id}">
                                <h3 class="text-lg font-semibold truncate pr-2 text-accent">${category.name}</h3>
                                <div class="flex items-center gap-3">
                                    <div class="relative options-btn-container">
                                        <button class="options-btn p-1 rounded-full hover:bg-primary/50" data-type="category" data-id="${category.id}">
                                           <svg class="w-5 h-5 text-text-muted pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                                        </button>
                                        <div class="options-menu hidden absolute right-0 mt-1 w-32 panel rounded-md shadow-lg z-10 animate-fade-in">
                                            <a href="#" class="edit-btn block px-4 py-2 text-sm text-text-muted hover:bg-primary">Editar</a>
                                            <a href="#" class="delete-btn block px-4 py-2 text-sm text-red-500 hover:bg-primary">Excluir</a>
                                        </div>
                                    </div>
                                    <svg class="w-6 h-6 text-text-muted transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>
                            <div class="subject-list ${isExpanded ? 'expanded' : ''}">
                                <div>
                                    <div class="p-4 border-t" style="border-color: rgba(42, 58, 144, 0.3);">
                                        <ul class="space-y-1 mb-4">
                                            ${subjectsHTML || placeholderHTML}
                                        </ul>
                                        <div class="flex flex-col sm:flex-row gap-2 mt-2">
                                            <input type="text" class="new-subject-input flex-grow bg-white border border-primary rounded-lg px-3 py-1 text-sm text-black placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-accent" placeholder="Novo assunto...">
                                            <div class="flex gap-2 justify-end">
                                                <button class="add-subject-btn bg-accent/80 hover:bg-accent text-white text-sm font-semibold py-1 px-3 rounded-lg glow-on-hover" data-id="${category.id}">Adicionar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        categoriesContainer.appendChild(categoryElement);
                    });

                    if (scrollY !== null) {
                        window.scrollTo(0, scrollY);
                    }
                };

                const handleSearch = (scrollY = null) => {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    if (!searchTerm) {
                        render(categories, scrollY);
                        return;
                    }
                    const filtered = categories.filter(cat =>
                        cat.name.toLowerCase().includes(searchTerm) ||
                        cat.subjects.some(sub => sub.toLowerCase().includes(searchTerm))
                    );
                    render(filtered, scrollY);
                };

                const toggleCategoryForm = () => {
                    addCategoryForm.classList.toggle('hidden');
                    if (!addCategoryForm.classList.contains('hidden')) newCategoryInput.focus();
                };

                const addCategory = () => {
                    const name = newCategoryInput.value.trim();
                    if (name) {
                        categories.unshift({ id: Date.now(), name, subjects: [], expanded: false });
                        newCategoryInput.value = '';
                        addCategoryForm.classList.add('hidden');
                        saveData();
                        render();
                    }
                };
                
                const handleContainerClick = (e) => {
                    const target = e.target;
                    const optionsBtn = target.closest('.options-btn');
                    
                    if (optionsBtn) {
                        e.stopPropagation();
                        const menu = optionsBtn.nextElementSibling;
                        const allMenus = document.querySelectorAll('.options-menu');
                        allMenus.forEach(m => {
                            if (m !== menu) m.classList.add('hidden');
                        });
                        menu.classList.toggle('hidden');
                        return;
                    }

                    const editBtn = target.closest('.edit-btn');
                    const deleteBtn = target.closest('.delete-btn');
                    
                    if (editBtn || deleteBtn) {
                        const parentMenu = target.closest('.options-menu');
                        const optionsContainer = parentMenu.parentElement;
                        const optionsButton = optionsContainer.querySelector('.options-btn');
                        const type = optionsButton.dataset.type;
                        const categoryId = Number(optionsButton.dataset.id);
                        
                        if (editBtn) {
                            e.preventDefault();
                            if (type === 'category') {
                                editCategory(categoryId);
                            } else {
                                const subjectName = optionsButton.dataset.subject;
                                editSubject(categoryId, subjectName);
                            }
                        } else if (deleteBtn) {
                            e.preventDefault();
                            if (type === 'category') {
                                showConfirmationModal('Excluir esta categoria e todos os seus assuntos?', () => deleteCategory(categoryId));
                            } else {
                                const subjectName = optionsButton.dataset.subject;
                                showConfirmationModal(`Excluir o assunto "${subjectName}"?`, () => deleteSubject(categoryId, subjectName));
                            }
                        }
                    } else if (target.closest('.category-header') && !target.closest('.options-btn-container')) {
                        const header = target.closest('.category-header');
                        const categoryId = Number(header.dataset.id);
                        const category = categories.find(c => c.id === categoryId);
                        if (category) {
                            category.expanded = !category.expanded;
                            saveData();
                            
                            const subjectList = header.nextElementSibling;
                            const arrowIcon = header.querySelector('svg:last-of-type');
                            subjectList.classList.toggle('expanded');
                            arrowIcon.classList.toggle('rotate-180');
                        }
                    } else if (target.closest('.add-subject-btn')) {
                        const addBtn = target.closest('.add-subject-btn');
                        const categoryId = Number(addBtn.dataset.id);
                        const input = addBtn.parentElement.parentElement.querySelector('.new-subject-input');
                        const subjectName = input.value.trim();
                        if (subjectName) {
                            const category = categories.find(c => c.id === categoryId);
                            if (category) {
                                category.subjects.push(subjectName);
                                input.value = '';
                                saveData();
                                handleSearch(window.scrollY);
                            }
                        }
                    }
                };
                
                const handleContainerKeypress = (e) => {
                     if (e.key === 'Enter' && e.target.classList.contains('new-subject-input')) {
                          e.target.nextElementSibling.querySelector('.add-subject-btn').click();
                     }
                };

                const editCategory = (id) => {
                    const category = categories.find(c => c.id === id);
                    if (!category) return;
                    const scrollY = window.scrollY;
                    showEditModal("Editar Categoria", category.name, (newName) => {
                        category.name = newName;
                        saveData();
                        handleSearch(scrollY);
                    });
                };

                const editSubject = (categoryId, subjectName) => {
                    const category = categories.find(c => c.id === categoryId);
                    const subjectIndex = category ? category.subjects.indexOf(subjectName) : -1;
                    if (subjectIndex === -1) return;
                    
                    const scrollY = window.scrollY;
                    showEditModal("Editar Assunto", subjectName, (newName) => {
                        category.subjects[subjectIndex] = newName;
                        saveData();
                        handleSearch(scrollY);
                    });
                };

                const deleteCategory = (id) => {
                    categories = categories.filter(c => c.id !== id);
                    saveData();
                    handleSearch();
                };

                const deleteSubject = (categoryId, subjectName) => {
                    const category = categories.find(c => c.id === categoryId);
                    if (category) {
                        category.subjects = category.subjects.filter(s => s !== subjectName);
                        saveData();
                        handleSearch(window.scrollY);
                    }
                };

                // --- Lógica de Importação, Exportação e Merge ---
                const exportToExcel = () => {
                    if (categories.length === 0) {
                        showModal("Não há dados para exportar.");
                        return;
                    }
                    const dataForExport = [];
                    categories.forEach(category => {
                        if (category.subjects.length > 0) {
                            category.subjects.forEach(subject => {
                                dataForExport.push({ "Categoria": category.name, "Assunto": subject });
                            });
                        } else {
                            dataForExport.push({ "Categoria": category.name, "Assunto": "" });
                        }
                    });
                    const worksheet = XLSX.utils.json_to_sheet(dataForExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Base de Conhecimento");
                    XLSX.writeFile(workbook, "base_de_conhecimento.xlsx");
                };

                const exportToMarkdown = () => {
                    if (categories.length === 0) {
                        showModal("Não há dados para exportar.");
                        return;
                    }
                    let markdownContent = "# Base de Conhecimento\n\n";
                    categories.forEach(category => {
                        markdownContent += `## ${category.name}\n`;
                        category.subjects.forEach(subject => {
                            markdownContent += `- ${subject}\n`;
                        });
                        markdownContent += '\n';
                    });

                    const blob = new Blob([markdownContent], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'base_de_conhecimento.md';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                const parseAndMergeText = (text) => {
                    const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                    if (lines.length === 0) return 0;
                    const dataToImport = {};
                    let importedCount = 0;
                    const startIndex = lines[0].toLowerCase().includes('categorias de assuntos\tassunto') ? 1 : 0;
                    for (let i = startIndex; i < lines.length; i++) {
                        const parts = lines[i].split('\t');
                        if (parts.length < 2) continue;
                        const categoryName = parts[0].trim();
                        const subjectName = parts[1].trim();
                        if (!dataToImport[categoryName]) dataToImport[categoryName] = [];
                        if (subjectName && !dataToImport[categoryName].includes(subjectName)) {
                             dataToImport[categoryName].push(subjectName);
                        }
                    }
                    for (const categoryName in dataToImport) {
                        importedCount++;
                        let existingCategory = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                        if (existingCategory) {
                            dataToImport[categoryName].forEach(subject => {
                                if (!existingCategory.subjects.find(s => s.toLowerCase() === subject.toLowerCase())) {
                                    existingCategory.subjects.push(subject);
                                }
                            });
                        } else {
                            categories.unshift({
                                id: Date.now() + Math.random(),
                                name: categoryName,
                                subjects: dataToImport[categoryName],
                                expanded: false
                            });
                        }
                    }
                    if (importedCount > 0) saveData();
                    return importedCount;
                };

                const processFileForImport = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const importedCount = parseAndMergeText(event.target.result);
                        showModal(importedCount > 0 ? `${importedCount} categorias importadas/atualizadas!` : 'Nenhuma categoria encontrada no arquivo.');
                        render();
                    };
                    reader.readAsText(file);
                    fileInput.value = ''; 
                };
                
                const showModal = (message, isConfirmation = false, onConfirm) => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in';
                    
                    const buttonsHTML = isConfirmation
                        ? `<div class="flex justify-center gap-4">
                               <button class="modal-cancel-btn bg-surface hover:bg-primary/50 text-text font-bold py-2 px-6 rounded-lg glow-on-hover">Cancelar</button>
                               <button class="modal-confirm-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg glow-on-hover">Confirmar</button>
                           </div>`
                        : `<button class="modal-close-btn mt-4 bg-accent hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg glow-on-hover">OK</button>`;

                    modal.innerHTML = `
                        <div class="panel text-text p-6 rounded-lg shadow-lg text-center max-w-sm mx-4 modal-container">
                            <p class="mb-4">${message}</p>
                            ${buttonsHTML}
                        </div>
                    `;
                    document.body.appendChild(modal);

                    if (isConfirmation) {
                        modal.querySelector('.modal-confirm-btn').addEventListener('click', () => { onConfirm(); document.body.removeChild(modal); });
                        modal.querySelector('.modal-cancel-btn').addEventListener('click', () => document.body.removeChild(modal));
                    } else {
                        modal.querySelector('.modal-close-btn').addEventListener('click', () => document.body.removeChild(modal));
                    }
                };

                const showConfirmationModal = (message, onConfirm) => showModal(message, true, onConfirm);
                
                const showEditModal = (title, currentValue, onSave) => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fade-in';
                    modal.innerHTML = `
                        <div class="panel text-text p-6 rounded-lg shadow-lg max-w-sm mx-4 w-full modal-container">
                            <h3 class="text-lg font-medium mb-4 text-accent">${title}</h3>
                            <input type="text" id="editInput" class="w-full bg-white border border-primary rounded-lg px-4 py-2 text-black mb-4 focus:outline-none focus:ring-2 focus:ring-accent" value="${currentValue.replace(/"/g, '&quot;')}">
                            <div class="flex justify-end gap-4">
                                <button class="modal-cancel-btn bg-surface hover:bg-primary/50 text-text font-bold py-2 px-6 rounded-lg glow-on-hover">Cancelar</button>
                                <button class="modal-save-btn bg-accent hover:opacity-90 text-white font-bold py-2 px-6 rounded-lg glow-on-hover">Salvar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    const editInput = modal.querySelector('#editInput');
                    editInput.focus();
                    editInput.select();

                    modal.querySelector('.modal-save-btn').addEventListener('click', () => {
                        const newValue = editInput.value.trim();
                        if (newValue) {
                            onSave(newValue);
                            document.body.removeChild(modal);
                        }
                    });
                    editInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') modal.querySelector('.modal-save-btn').click();
                    });
                    modal.querySelector('.modal-cancel-btn').addEventListener('click', () => document.body.removeChild(modal));
                };

                // --- Lógica do Dashboard de Atendimentos ---
                const processTicketData = (text) => {
                    const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        showModal("Arquivo de atendimentos vazio ou em formato inválido.");
                        return;
                    }

                    const headers = lines[0].split('\t').map(h => h.trim());
                    const data = lines.slice(1).map(line => {
                        const values = line.split('\t');
                        const entry = {};
                        headers.forEach((header, index) => {
                            entry[header] = values[index] ? values[index].trim() : '';
                        });
                        return entry;
                    });

                    ticketsDashboardContent.classList.remove('hidden');
                    generateTicketCharts(data);
                };

                const updateChartDisplay = (chartId, showAll) => {
                    const chart = chartInstances[chartId];
                    const fullData = fullChartData[chartId];
                    const canvasEl = document.getElementById(chartId);
                    const toggleBtn = document.querySelector(`[data-chart-id="${chartId}"]`);
                    const limit = 10;

                    if (!chart || !fullData) return;

                    const dataToShow = (showAll || fullData.labels.length <= limit)
                        ? { labels: fullData.labels, datasets: fullData.datasets }
                        : { labels: fullData.labels.slice(0, limit), datasets: fullData.datasets.map(ds => ({ ...ds, data: ds.data.slice(0, limit) })) };
                    
                    chart.data.labels = dataToShow.labels;
                    chart.data.datasets = dataToShow.datasets;
                    
                    const isHorizontal = chart.options.indexAxis === 'y';
                    const heightMultiplier = isHorizontal ? 30 : 20;
                    const baseHeight = isHorizontal ? 250 : 400;

                    const newHeight = Math.max(baseHeight, dataToShow.labels.length * heightMultiplier);
                    canvasEl.parentElement.style.height = `${newHeight}px`;

                    chart.update();

                    if (fullData.labels.length > limit) {
                        toggleBtn.classList.remove('hidden');
                        const arrow = `<svg class="inline-block w-4 h-4 transition-transform duration-200 ${showAll ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
                        toggleBtn.innerHTML = `${showAll ? 'Ver menos' : 'Ver mais'} ${arrow}`;
                        toggleBtn.dataset.state = showAll ? 'expanded' : 'collapsed';
                    } else {
                        toggleBtn.classList.add('hidden');
                    }
                };
                
                const generateTicketCharts = (data) => {
                    totalTicketsEl.textContent = data.length;
                    const uniqueAgents = new Set(data.map(item => item['Responsável do ticket']));
                    const uniqueTicketTypes = new Set(data.map(item => item['Tipo do chamado (Campo personalizado de ticket)']));
                    totalAgentsEl.textContent = uniqueAgents.size;
                    totalTicketTypesEl.textContent = uniqueTicketTypes.size;

                    const backgroundColors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444'];
                    Object.values(chartInstances).forEach(instance => instance?.destroy());

                    const chartOptions = (isStacked = false) => ({
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { labels: { color: '#e5e7eb' }, display: isStacked } },
                        scales: { 
                            x: { stacked: isStacked, ticks: { color: '#e5e7eb' }, grid: { color: 'rgba(255,255,255,0.1)' } }, 
                            y: { stacked: isStacked, ticks: { color: '#e5e7eb', autoSkip: false }, grid: { color: 'rgba(255,255,255,0.1)' } } 
                        }
                    });
                    
                    const typeCounts = data.reduce((acc, item) => {
                        const type = item['Tipo do chamado (Campo personalizado de ticket)'];
                        if(type) acc[type] = (acc[type] || 0) + 1;
                        return acc;
                    }, {});
                    const sortedTypeCounts = Object.entries(typeCounts).sort(([,a],[,b]) => b-a);
                    fullChartData.ticketTypesChart = {
                        labels: sortedTypeCounts.map(item => item[0]),
                        datasets: [{ label: 'Total de Chamados', data: sortedTypeCounts.map(item => item[1]), backgroundColor: backgroundColors }]
                    };

                    const categoryCounts = data.reduce((acc, item) => {
                        const category = item['Categoria de assunto do ticket'];
                        if(category) acc[category] = (acc[category] || 0) + 1;
                        return acc;
                    }, {});
                    const sortedTicketCategories = Object.entries(categoryCounts).sort(([,a],[,b]) => b-a);
                    fullChartData.ticketCategoriesChart = {
                        labels: sortedTicketCategories.map(item => item[0]),
                        datasets: [{ label: 'Nº de Tickets', data: sortedTicketCategories.map(item => item[1]), backgroundColor: backgroundColors }]
                    };

                    const subjectCounts = data.reduce((acc, item) => {
                        const subject = item['Assunto do ticket'];
                        if(subject) acc[subject] = (acc[subject] || 0) + 1;
                        return acc;
                    }, {});
                    const sortedTicketSubjects = Object.entries(subjectCounts).sort(([,a],[,b]) => b-a);
                    fullChartData.ticketSubjectsChart = {
                        labels: sortedTicketSubjects.map(item => item[0]),
                        datasets: [{ label: 'Nº de Tickets', data: sortedTicketSubjects.map(item => item[1]), backgroundColor: backgroundColors }]
                    };

                    const categoryByTypeData = {};
                    const allTypes = [...uniqueTicketTypes].filter(Boolean);
                    const topCategories = sortedTicketCategories.map(item => item[0]);
                    data.forEach(item => {
                        const category = item['Categoria de assunto do ticket'];
                        const type = item['Tipo do chamado (Campo personalizado de ticket)'];
                        if (!category || !type || !topCategories.includes(category)) return;
                        if (!categoryByTypeData[category]) {
                            categoryByTypeData[category] = {};
                            allTypes.forEach(t => categoryByTypeData[category][t] = 0);
                        }
                        categoryByTypeData[category][type]++;
                    });
                    fullChartData.categoryByTypeChart = {
                        labels: topCategories,
                        datasets: allTypes.map((type, index) => ({
                            label: type,
                            data: topCategories.map(cat => categoryByTypeData[cat]?.[type] || 0),
                            backgroundColor: backgroundColors[index % backgroundColors.length]
                        }))
                    };

                    chartInstances.ticketTypesChart = new Chart(document.getElementById('ticketTypesChart'), { type: 'bar', data: {}, options: chartOptions() });
                    chartInstances.ticketCategoriesChart = new Chart(document.getElementById('ticketCategoriesChart'), { type: 'bar', data: {}, options: chartOptions() });
                    chartInstances.ticketSubjectsChart = new Chart(document.getElementById('ticketSubjectsChart'), { type: 'bar', data: {}, options: chartOptions() });
                    chartInstances.categoryByTypeChart = new Chart(document.getElementById('categoryByTypeChart'), { type: 'bar', data: {}, options: chartOptions(true) });

                    Object.keys(chartInstances).forEach(id => updateChartDisplay(id, false));
                };

                // --- Lógica para os Dropdowns de Atendimento ---
                const initializeDropdowns = async () => {
                    const ticketSelectorPanel = document.getElementById('ticket-selector-panel');
                    const categorySelect = document.getElementById('ticketCategorySelect');
                    const subjectSelect = document.getElementById('ticketSubjectSelect');

                    // =================================================================================
                    // IMPORTANTE: Substitua a URL abaixo pela URL do seu arquivo .txt no GitHub
                    // Para obter a URL correta:
                    // 1. Vá para o seu arquivo .txt no repositório do GitHub.
                    // 2. Clique no botão "Raw".
                    // 3. Copie a URL da barra de endereço do seu navegador.
                    // =================================================================================
                    const fileUrl = https://raw.githubusercontent.com/DaniloAMoreira/Categorias-assuntos-atualizado/refs/heads/main/index.html;

                    try {
                        const response = await fetch(fileUrl);
                        if (!response.ok) {
                            throw new Error(`Erro de rede! Status: ${response.status}`);
                        }
                        const dadosBrutos = await response.text();

                        // Processa os dados brutos para agrupar assuntos por categoria
                        const dadosAgrupados = dadosBrutos
                            .trim()
                            .split('\n')
                            .map(line => line.split('\t').map(item => item.trim()))
                            .reduce((acc, [categoria, assunto]) => {
                                if (categoria && assunto) {
                                    if (!acc[categoria]) {
                                        acc[categoria] = new Set(); // Usa Set para evitar duplicatas
                                    }
                                    acc[categoria].add(assunto);
                                }
                                return acc;
                            }, {});

                        // Converte os Sets para Arrays e ordena
                        const dadosFinais = {};
                        for (const categoria in dadosAgrupados) {
                            dadosFinais[categoria] = Array.from(dadosAgrupados[categoria]).sort();
                        }
                        
                        // Limpa o placeholder e preenche o dropdown de categorias
                        categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                        const categoriasOrdenadas = Object.keys(dadosFinais).sort();
                        categoriasOrdenadas.forEach(categoria => {
                            const option = document.createElement('option');
                            option.value = categoria;
                            option.textContent = categoria;
                            categorySelect.appendChild(option);
                        });

                        // Adiciona o listener para o dropdown de categorias
                        categorySelect.addEventListener('change', () => {
                            const categoriaSelecionada = categorySelect.value;
                            subjectSelect.innerHTML = ''; // Limpa as opções anteriores

                            if (categoriaSelecionada) {
                                const assuntos = dadosFinais[categoriaSelecionada];
                                
                                let option = document.createElement('option');
                                option.value = "";
                                option.textContent = "Selecione um assunto";
                                subjectSelect.appendChild(option);

                                assuntos.forEach(assunto => {
                                    option = document.createElement('option');
                                    option.value = assunto;
                                    option.textContent = assunto;
                                    subjectSelect.appendChild(option);
                                });
                            } else {
                                let option = document.createElement('option');
                                option.value = "";
                                option.textContent = "Aguardando seleção da categoria";
                                subjectSelect.appendChild(option);
                            }
                        });

                    } catch (error) {
                        console.error('Erro ao carregar o arquivo de categorias:', error);
                        categorySelect.innerHTML = '<option value="">Erro ao carregar dados</option>';
                        subjectSelect.innerHTML = '<option value="">-</option>';
                    }
                };


                // --- Listeners de Eventos ---
                tabKnowledge.addEventListener('click', () => switchTab('knowledge'));
                tabDashboardKnowledge.addEventListener('click', () => switchTab('dashboard-knowledge'));
                tabDashboardTickets.addEventListener('click', () => switchTab('dashboard-tickets'));
                
                searchInput.addEventListener('input', () => handleSearch());
                addCategoryBtn.addEventListener('click', toggleCategoryForm);
                saveCategoryBtn.addEventListener('click', addCategory);
                newCategoryInput.addEventListener('keypress', (e) => e.key === 'Enter' && addCategory());
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.options-btn-container')) {
                        document.querySelectorAll('.options-menu').forEach(m => m.classList.add('hidden'));
                    }
                    if (!e.target.closest('#exportBtn')) {
                        exportMenu.classList.add('hidden');
                    }
                    if (e.target.closest('.toggle-chart-btn')) {
                        const btn = e.target.closest('.toggle-chart-btn');
                        const chartId = btn.dataset.chartId;
                        const isExpanded = btn.dataset.state === 'expanded';
                        updateChartDisplay(chartId, !isExpanded);
                    }
                });

                categoriesContainer.addEventListener('click', handleContainerClick);
                categoriesContainer.addEventListener('keypress', handleContainerKeypress);
                importBtn.addEventListener('click', () => fileInput.click());
                exportBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    exportMenu.classList.toggle('hidden');
                });
                exportExcelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportToExcel();
                    exportMenu.classList.add('hidden');
                });
                exportMarkdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportToMarkdown();
                    exportMenu.classList.add('hidden');
                });

                fileInput.addEventListener('change', processFileForImport);
                loadTicketsBtn.addEventListener('click', () => ticketsFileInput.click());
                ticketsFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => processTicketData(event.target.result);
                    reader.readAsText(file, 'UTF-8');
                    ticketsFileInput.value = '';
                });

                // --- Inicialização da Aplicação ---
                loadData();
                initializeDropdowns(); // Chama a função que inicializa os dropdowns
            };

            // --- Ponto de Entrada Inicial ---
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            checkLoginState();
        });
    </script>
</body>
</html>
